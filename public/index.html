<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>ğŸ§¾ ë³´ìœ  ì¢…ëª© ì…ë ¥</h2>
  <label>ì¢…ëª© ê°œìˆ˜:
    <input type="number" id="stockCount" min="1" max="20" value="3">
  </label>
  <button onclick="generateInputs()">ì…ë ¥ì¹¸ ìƒì„±</button>

  <form id="portfolioForm">
    <div id="stockInputs"></div>
    <button type="submit">í¬íŠ¸í´ë¦¬ì˜¤ ë³´ê¸°</button>
  </form>

  <canvas id="portfolioChart" width="600" height="400"></canvas>

  <script>
    let portfolioChart = null;

    function generateInputs() {
      const count = parseInt(document.getElementById('stockCount').value);
      const container = document.getElementById('stockInputs');
      container.innerHTML = ''; // ì´ˆê¸°í™”

      for (let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.innerHTML = `
          <input type="text" placeholder="ì¢…ëª©ì½”ë“œ (ì˜ˆ: TSLA)" name="symbol${i}" required>
          <input type="number" placeholder="ë³´ìœ ìˆ˜ëŸ‰" name="quantity${i}" min="0" required>
        `;
        container.appendChild(div);
      }
    }

    document.getElementById('portfolioForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const inputs = Array.from(document.querySelectorAll('#stockInputs div'));
      const entries = inputs.map(div => {
        const [symbolInput, quantityInput] = div.querySelectorAll('input');
        return {
          symbol: symbolInput.value.trim().toUpperCase(),
          quantity: parseFloat(quantityInput.value)
        };
      });

      const symbols = entries.map(entry => entry.symbol);
      const quantities = Object.fromEntries(entries.map(entry => [entry.symbol, entry.quantity]));

      try {
        const response = await axios.post('http://localhost:3000/prices', { symbols });
        const data = response.data;

        const labels = [];
        const values = [];

        data.forEach(item => {
          const qty = quantities[item.symbol] ?? 0;
          const price = item.price ?? 0;
          const total = price * qty;

          if (total > 0) {
            labels.push(item.symbol);
            values.push(total);
          }
        });

        const ctx = document.getElementById('portfolioChart').getContext('2d');

        if (portfolioChart instanceof Chart) {
          portfolioChart.destroy();
        }

        portfolioChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              label: 'í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘',
              data: values,
              backgroundColor: [
                '#4dc9f6', '#f67019', '#f53794',
                '#537bc4', '#acc236', '#166a8f',
                '#00a950', '#58595b', '#8549ba'
              ]
            }]
          },
          options: {
            plugins: {
              legend: {
                position: 'right'
              }
            }
          }
        });

      } catch (error) {
        alert('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        console.error(error);
      }
    });

    generateInputs(); // ìµœì´ˆ ì‹¤í–‰ ì‹œ ê¸°ë³¸ ì…ë ¥ì¹¸ ìƒì„±
  </script>
</body>
</html>
